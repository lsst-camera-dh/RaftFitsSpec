\documentclass{article}[12pt]

% Math & clever spacing
\usepackage{amsmath}
\usepackage{amssymb}
\usepackage{xspace}

% Graphics and colors
\usepackage{graphicx}
\usepackage{xcolor}
\usepackage{color}

% disable subsubsections in the TOC
%\makeatletter
%\def\l@subsubsection#1#2{}
%\makeatother

% Fix the appendix lines in the TOC
%\renewcommand*{\appendixname}{}

% Line number every fifth line
%\modulolinenumbers[5]
%\linenumbers

\usepackage[top=1in, bottom=1.25in, left=0.75in, right=0.75in]{geometry}

\usepackage[T1]{fontenc}
\renewcommand*\rmdefault{ptm}

\usepackage{hyperref}
\usepackage{listings}
\usepackage{url}
\usepackage{tablefootnote}
\usepackage{fancyhdr}
\pagestyle{fancy}

\fancyhead{}
\fancyfoot{}
\fancyhead[LO,LE]{LCA-13501}
\fancyhead[CO,CE]{FITS Format Specification for Science Rafts}
\fancyhead[RO,RE]{Page \thepage~of XX}

\usepackage{alltt}

% Title page 
\title{Specification for FITS Image Files from Raft and Focal Plane-Level Electro-Optical Tests}

\newcommand{\red}{\textcolor{red}}
\newcommand{\blue}{\textcolor{blue}}
\definecolor{darkgreen}{rgb}{0.0, 0.7, 0.0}
\newcommand{\green}{\textcolor{darkgreen}}

% Body of the document
\begin{document}

\maketitle
\tableofcontents

\section{Change History}
Initial draft in progress.  \red{Issues for discussion are highlighted in red.}

The source for this draft, including ASCII versions of the example headers, is maintained at \url{https://github.com/lsst-camera-dh/RaftFitsSpec}.

\section{Scope}
This document describes the naming, organization, and formats of the FITS files from Science Raft-level and focal plane-level (i.e., more than one raft) electro-optical tests.  The definitions of other data products related to raft and focal plane-level metrology will be described elsewhere.

\section{Acronyms}

\section{References}

[1] LCA-10140 Specification for FITS Images from Electro-Optical Tests

\noindent{[2] LSST-1614 LSST Camera Coordinate and Numbering Systems}

\noindent{[3] LSST-13381 LSST Camera Detector Plane Layout}

\noindent{FITS standards, references, and resources are collected here:  \url{http://fits.gsfc.nasa.gov}.}

\section{Introduction}
This document extends the definition of formats and naming conventions for single-sensor image files [1] to images taken at the raft level (i.e., nine sensors), or collections of rafts up to the entire focal plane.  As for single sensors, the image files will be in FlTS format, long in widespread use in astronomy.  The FITS standard is well defined and many i/o libraries and tools exist to read, write, manipulate, and display data stored in FITS format.  The format consists of keyword-value pairs in ASCII headers together with (typically) binary image data or tables.  A header and associated data are together called a Header Data Unit, and a FITS file can contain any number of these.

Raft-level images will be generated with Test Stand 8 (TS8).  Focal plane-level images will be generated with the Bench for Optical Testing (BOT).  BNL and SLAC will each have a TS8.  The BOT will be at SLAC.  The specifications in this document are to ensure portability of the image data products across sites, to provide a well-defined common interface for the analysis scripts, to define pixel coordinate keywords for image assembly by display tools (specifically ds9 and Firefly), and to facilitate curation of raft and camera test data.

As for sensor acceptance testing, raft and focal plane-level image files will be used for any of a variety of analyses, depending on the set-up of the test stands, including Flat Field Exposures, Pocket-Pumping Exposures, Dark Integrations, Fe-55 X-ray Exposures, Wavelength Scan, Superflat Images, Spot Imaging Exposures, Readout System Noise Images, and Readout System Crosstalk Images.
The format specifications of the image files from these tests are very similar but some tests have test-specific keywords.  

The specifications of the file and directory naming conventions, and of the FITS headers derive from the corresponding specifications in LCA-10103 for single sensor testing.

\section{File Naming and Directory Structure}
Considerations of human readability, data curation, and automated processing motivate specification of conventions for naming and organization of the image files.

\subsection{Directory Structure}

The directory structure for raft-level measurements is designed to extend from measurements with single rafts (in TS8) to entire focal planes (with the BOT).  The naming convention is:

{\bf rafts/<institution>/sraft\#\#/<acquisition type>/<job ID>/<s\#\#>}

\red{An example with the desired directory path:}

\red{{\tt .../sraft22/dark\_acq/361/s12/E2V-CCD250-088\_dark\_dark\_3\_20160121191343.fits}}

%\red{N.B. This organization is not currently possible with the Job Harness system}

%\red{TBD: expand <test type> to list the acquisition and analysis directories actually used?  Possibly limit to just the acquisition directories - this document is not defining specs for the analysis results directory/file naming or formats}
%\red{Are there other acquisition types to be listed?  The directories with analysis results, and the results files themselves provisionally are not included in this specification.}

%\red{Subdirectories for sensor names/raft locations}

\begin{table}
\begin{centering}
\begin{tabular}{| l | l |}
\hline
{\bf Quantity} & {\bf Description} \\
\hline
%{\bf rafts} & A designator to distinguish from {\bf CCDs} for single-sensor data sets \\
{\bf <institution>} & {\bf bnl} or {\bf slac} \\
{\bf sraft<\#\#>} & Designator of the science raft (each \# = 0--4) \\
{\bf <acquisition type>} & {\bf dark\_acq, fe55\_acq, flat\_acq, lambda\_acq, ppump\_acq, qe\_acq, read\_noise, spot\_acq} \\
{\bf <job ID>} & Job ID number assigned by the Job Harness \\
{\bf <s\#\#>} & Location designator of the sensor in the raft (each \# = 0--2) \\
\hline
\end{tabular}
\caption{Definitions of the components of the directory names for image data./label{tab:dir}}
\end{centering}
\end{table}

%{\bf Use the same designators for test type as in the EO test directories?}

%\red{These directories may contain subdirectories, perhaps depending on the test type...}


\subsection{File Names}

The file names for a given sensor, test type, and processing step shall be of the form
%<sensor id>_<test type>_<image type>_<seq. info>_<time stamp>.fits
<sensor id>\_<test type>\_<image type>\_<seq. info>\_<time stamp>.fits


\red{TBD:  Include metrology files}

\begin{table}
\begin{centering}
\begin{tabular}{| l | l |}
\hline
{\bf Quantity} & {\bf Description} \\
\hline
{\bf <CCD id>} & {\bf s{\tt \#\#}}, where {\tt \#\#} are the coordinates of the CCD in the raft; each \# = 0--2, as defined in [2] \\
{\bf <test type>} & {\bf dark, fe55, flat, lambda, spot} \\
{\bf <image type>} & One of bias, dark, fe55, or flat \\
{\bf <seq. info>} & Normally a 3-digit sequence number such as 000, 001, 002. \tablefootnote{Photon Transfer Curve data (pairs of flats) shall have exposure times and flat1/flat2 designators, e.g., 0010.0s\_flat1} \\
{\bf <time stamp>} & A string of the form YYYYMMDDHHMMSS recording UTC of the start of the image acquisition\\
\hline
\end{tabular}
\caption{Definitions of the components of the file names for image data.\label{tab:file}}
\end{centering}
\end{table}

\section{Internal File Organization}

The image files are multiple-extension FITS files with basic (not site-specific) information in the primary header, then 16 image extensions (one per segment), followed by test condition, CCD operating condition, and site-specific extension(s).  For the latter, examples are given here but are not formally part of the specification.  N.B.: The analysis scripts should not depend on information in the site-specific extensions.

\subsection{Image Extensions}

The naming of the segments is defined in [2].  Each segment has a 2-digit designator, and these are incorporated in the {\tt EXTNAME} keyword strings as indicated in the example header below.

The headers of the image extensions also define the pixel coordinate systems for the segments, sensors, and rafts.  These use a combination of NOAO Mosaic keyword conventions as in [1] and FITS World Coordinate System (WCS) definitions (ref).  The definitions specify which regions of the segments are pre-scan and over-scan regions.  (For TS8 a focal-plane level definition of the pixel coordinates is not needed.)

\section{Example Headers}

\subsection{Primary Header}
This example is the primary header of an image file for an ITL sensor, although the primary header is not sensor-specific.  It goes without saying that values of many of the keywords in actual data files will be different.  Keyword values are shown here and in the other example headers as a guide to the format.

%\red{
%Points for discussion:
%\begin{itemize}
%\item{LSST\_NUM, defined as the LSST-assigned serial number, is in LCA-10140 but not here}
%\item{MONOCH-SLIT\_C, AMP0-AZERO, and AMP2-ZERO\_CHECK keywords below are not in LCA-10140.}
%\item{Are the BINX and BINY keywords useful?}
%\item{LCA-10140 has DATE/MJD as the creation date of the file.  These is not in the example header below.}
%\item{MJD-OBS, the MJD date of the image acquisition, is not in LCA-10140}
%\item{What are the possible values of IMGTYPE?}
%\end{itemize}
%}

\begin{table}
\begin{alltt}
\input{primary_header.txt}
\end{alltt}
\caption{Example primary header.\label{tab:primary}}
\end{table}

\subsection{Image Extension Header (ITL)}
This example is the first image extension of an image file for an ITL sensor.  The other 15 extensions are of course similar but differ in the keywords specifying the mapping of amplifier (segment) coordinates to coordinates within a sensor, raft, or focal plane.  The calculation of these keyword values is provided in \S~\ref{sec:coords_itl}.

\begin{table}
\begin{alltt}
\input{image_header_seg10_ITL.txt}
\end{alltt}
\caption{Example header of an image extension for an ITL sensor. \label{tab:image_ITL}}
\end{table}

\subsection{Image Extension Header (E2V)}

This is an example of an image extension for an E2V sensor.  It is the first segment (Segment10) in the file.

\begin{table}
\begin{alltt}
\input{image_header_seg10_E2V.txt}
\end{alltt}
\caption{Example header of an image extension for an e2V sensor.\label{tab:image_e2V}}
\end{table}

\subsection{Test Conditions Header}

\red{
\begin{itemize}
\item{What are the allowed values of the FILTER keyword?}
\item{LCA-10140 has the MONOWL keyword (Monochromator wavelength setting), but it is not in the example header}
\item{LCA-10140 has PD\_SER (Monitor Photodiode serial number), but this keyword is not in the example header.}
\end{itemize}
}

\begin{table}
\begin{alltt}
\input{test_cond_header.txt}
\end{alltt}
\caption{Example Test Conditions extension header.\label{table:test_cond}}
\end{table}

\subsection{CCD Conditions Header}

\red{
\begin{itemize}
\item{The CCD\_COND headers are just placeholders in recent single sensor image files.  Are they needed?  In LCA-10140 they contained keywords defining currents and voltages for the segments.  These probably were controller settings rather than read-out values.}
\end{itemize}
}

\begin{table}
\begin{alltt}
\input{ccd_cond_header.txt}
\end{alltt}
\caption{Example CCD Conditions extension header.\label{table:ccd_cond}}
\end{table}


\section{Pixel Coordinate Mapping}
This section describes the calculations for mapping segments to sensors, rafts, and the focal plane, defining the shifts and rotations to make continuous pixel coordinate systems.  The pixel coordinate systems are based on the nominal layout of the rafts and focal plane as defined in [3], and are intended to be used primarily for visualization during I\&T of Science Rafts and of the Camera focal plane.  The relevant diagrams of [3] are reproduced in Figures 1--3.  The segments, CCDs, and rafts each have two-digit identifiers that correspond to their x, y locations in the layout.

The transformations are developed here in terms of the FITS World Coordinate System (WCS) keyword specifications for FITS image data [ref].  The next subsection describes the WCS FITS keywords used.

%That is, describe how to derive the values for the MOSAIC and WCS keywords.

%The focal plane layout defined in [3] specifies the nominal locations of the rafts and the sensors within the rafts.


\subsection{Important Conventions}
Note that the layout is represented in [3] as viewed through L3, i.e., looking down on the CCDs.  In this orientation, the x direction of the Camera Coordinate System is toward the $left$ and the y direction is $up$.  This convention is adopted here.  Note also that by this convention, the nominal x (serial) direction of a sensor is oriented along the y direction of the Camera Coordinate System.  

By convention for FITS image data, the first pixel in an image has coordinates (1, 1).  This is adopted here for sensors and rafts.  In particular, the first pixel in an assembled raft image is assigned to the lower right pixel of Segment 00 in CCD 00, regardless of whether that CCD is actually present.  

For focal plane-level images, the origin of the pixel coordinate system is defined as if a Raft 00 were present.  That is, pixel (1, 1) would have been in segment 00 of CCD 00 in Raft 00.  The only other potential reference point, the center of the Camera focal plane (i.e., the center of CCD 11 in Raft 22) has the disadvantage of being between pixels, and adopting it as the origin would mean including 0.5 pixel offsets for pixel coordinates measured with respect to it.

\subsection{Pixel Coordinate Transformations}
In the following $S$ is the segment location designator, $C$ is the CCD location designator in a raft, and $R$ is the raft location designator in the focal plane.  Where useful, these designators are decomposed into their x and y index values, e.g., $S = 10 \times S_x + S_y$.

\begin{figure}
\centering
    \includegraphics[width=0.95\textwidth]{sensor_layout.pdf}
    \caption{Dimensions and segment layouts for e2V {\it (left)} and ITL {\it (right)} CCDs.  Note that the camera coordinate system has the x axis oriented along what is the $-$y direction for single-sensor assembled images.  These images are from [3].}
    \label{fig:sensor}
\end{figure}

\begin{figure}
\centering
    \includegraphics[width=0.95\textwidth]{raft_layout.pdf}
    \caption{Dimensions and sensor layouts for e2V {\it (left)} and ITL {\it (right)} Science Rafts.  These images are from [3].}
    \label{fig:raft}
\end{figure}

\begin{figure}
\centering
    \includegraphics[width=0.95\textwidth]{focal_plane_layout.pdf}
    \caption{Dimensions and arrangements of the rafts in the focal plane, from [3].}
    \label{fig:focalplane}
\end{figure}

\subsection{Dimensions and Pitch}
The relevant quantities for defining the pixel coordinate systems are listed in Table~\ref{tab:dims}.  All are extracted from the diagrams in [3].  The column {\bf Designator} lists the name of the corresponding variable in the algorithmic description of the coordinate calculation.  N.B. These variables are defined in terms of equivalent pixels, i.e., they are the physical dimensions divided by the pixel size.

\begin{table}
\begin{centering}
\begin{tabular}{| l | c | c | c |}
\hline
{\bf Quantity} & {\bf e2V CCD} & {\bf ITL CCD} & {\bf Designator} \\
\hline
%Pixel size & 10~$\mu$m $\times$ 10~$\mu$m & 10~$\mu$m $\times$ 10~$\mu$m & -- \\
Segment pixels & $2002 \times 512$ (vertical $\times$ horizontal) & $2000 \times 509$ & dimv $\times$ dimh \\
Active area  (x $\times$ y) \tablefootnote{Note that the dimensions are specified here in terms of the orientation of the CCDs in the raft.} & 4004  $\times$ 4096 & 4000 $\times$ 4072  & cay $\times$ cay \\
CCD physical size & 4197 $\times$ 4200 & 4198 $\times$ 4198 & ccdpx $\times $ ccdpy \\
%Pitch of CCDs & 4225 $\times$ 4225 & 4225 $\times$ 4225 & -- \\
Inter-CCD gaps & 28 $\times$ 25 & 27 $\times$ 27 & gap\_inx $\times$ gap\_iny \\
Pitch of rafts & 12700 & 12700 & raftx $\times$ rafty \\
Gaps at edges of rafts & 27 $\times$ 25 & 26 $\times$ 26 & gap\_outx $\times$ gap\_outy \\
\hline
\end{tabular}
\caption{CCD and raft-related dimensional quantities for the pixel coordinate systems, from [3].  The physical dimensions have been converted to pixels for the nominal 10~$\mu$m $\times$ 10~$\mu$m pixel size.\label{tab:dims}}
\end{centering}
\end{table}


%\begin{table}
%\begin{tabular}{| l | c | c | c |}
%\hline
%{\bf Quantity} & {\bf e2V Raft} & {\bf ITL Raft} & {\bf Designator} \\
%\hline
%Pitch of CCDs & 4225 $\times$ 4225 & 4225 $\times$ 4225 & -- \\
%Inter-CCD gaps & 28 $\times$ 25 & 27 $\times$ 27 & gap\_inx $\times$ gap\_iny \\
%Pitch of rafts & 12700 & 12700 & raftx $\times$ rafty \\
%Gap at edges of rafts & 27 $\times$ 25 & 26 $\times$ 26 & gap\_outx $\times$ gap\_outy \\
%\hline
%\end{tabular}
%\caption{Science Raft-related dimensional quantities for the pixel coordinate systems.  The physical dimensions have been converted to pixels for the nominal 10~$\mu$m $\times$ 10~$\mu$m pixel size.\label{tab:raft}}
%\end{table}

Let $(x_s, y_s)$ denote pixel coordinates in a given segment $S$, as read out, so that $x_s$ is in the serial direction and $y_s$ is in the parallel direction, and consider them to be in as-read-out order, without transpositions to account for the locations of the output nodes.  Then if $S$ is in CCD $C$ and the CCD is in raft $R$, then the pixel coordinates in each system can be defined as follows.

Keeping in mind that the CCD is oriented as in Figure 1 (i.e., rotated so the parallel direction is vertical), then the corresponding pixel coordinates in the CCD system are 
\begin{equation}
x_c = y_s (1 - S_x) + (2 \times {\rm dimv} + 1 - y_s)  S_x
\end{equation}

and (for e2V CCDs)

\begin{equation}
y_c = (x_s + S_y \times {\rm dimh})  (1 - S_x) + [1 - x_s + (S_y + 1) \times {\rm dimh}] S_x
\end {equation}
or (for ITL CCDs)

\begin{equation}
y_c = (1 - x_s + (S_y  + 1) \times {\rm dimh} )  (1 - S_x) + [1 - x_s + (S_y + 1) \times {\rm dimh}] S_x
\end{equation}

The corresponding pixel coordinates in the raft are:

\begin{equation}
x_r = x_c + {\rm gap\_outx} + 0.5({\rm ccdpx} - {\rm ccdax}) + C_x ( 2 \times {\rm dimv} + {\rm gap\_inx} + {\rm ccdpx} - {\rm ccdax})
\end{equation}

and

\begin{equation}
y_r = y_c + {\rm gap\_outy} + 0.5({\rm ccdpy} - {\rm ccday}) + C_y ( 8 \times {\rm dimh} + {\rm gap\_iny} + {\rm ccdpy} - {\rm ccday})
\end{equation}

And the corresponding coordinates in the focal plane are:

\begin{equation}
x_f = x_r + R_x \times {\rm raftx}
\end{equation}

and

\begin{equation}
y_f = y_r + R_y \times {\rm rafty}
\end{equation}

%N.B. The actual separation between the edges of adjacent rafts is twice the gap sizes listed in the last entry of the table above.

%The dimensions in the table above can be converted to equivalent numbers of pixels by dividing by 10 $\mu$m, i.e., multiplying the dimensions in mm by 100.

\subsection{Coordinate Keyword Values (e2V)\label{sec:coords_e2V}}
This section defines the coordinate keywords for the headers of ITL image files.   

%The pixel coordinate system for the focal plane is approximate, of course, accounting for the nominal gaps between the sensors and rafts.  For simplicity, each raft is assigned to a fixed range of x and y pixel coordinates in the focal plane.  The differences in the pixel dimensions of E2V and ITL sensors are taken up by adjusting the gap between rafts by a small amount.  This scheme would also simplify handling a hybrid focal plane of E2V-only and ITL-only rafts.

\subsection{World Coordinate System FITS Keywords}
The FITS World Coordinate System (WCS) keyword specification allows multiple coordinate systems to be defined for the same image.  We take advantage of that capability here
\subsection{Coordinate Keyword Values (E2V)\label{sec:coords_ifl}}

\begin{alltt}
WCSNAMEA= 'AMPLIFIER'          / Name of coordinate system
CTYPE1A = 'Seg_X   '           / In the camera coordinate system
CTYPE2A = 'Seg_Y   '           / In the camera coordinate system
CRVAL1A =                  1.0
CD1_1A  =                 -1.0
CD1_2A  =                  0.0
CD2_1A  =                  0.0
CD2_2A  =                 -1.0
CRPIX1A =                545.0
CRPIX2A =               4097.0
WCSNAMEC= 'CCD'                / Name of coordinate system
CTYPE1C = 'CCD_X   '           / In the camera coordinate system
CTYPE2C = 'CCD_Y   '           / In the camera coordinate system
CRVAL1C =                  1.0
CD1_1AC =                 -1.0
CD1_2AC =                  0.0
CD2_1AC =                  0.0
CD2_2AC =                 -1.0
CRPIX1C =                545.0
CRPIX2C =               4097.0
WCSNAMER= 'RAFT'               / Name of coordinate system
CTYPE1R = 'RAFT_X'             / In the camera coordinate system
CTYPE2R = 'RAFT_Y'             / In the camera coordinate system
CRVAL1R =                  1.0
CD1_1AR =                 -1.0
CD1_2AR =                  0.0
CD2_1AR =                  0.0
CD2_2AR =                 -1.0
CRPIX1R =                545.0
CRPIX2R =               4097.0
WCSNAMEF= 'FOCAL_PLANE'        / Name of coordinate system
CTYPE1F = 'FP_X'               / In the camera coordinate system
CTYPE2F = 'FP_Y'               / In the camera coordinate system
CRVAL1F =                  1.0
CD1_1AF =                 -1.0
CD1_2AF =                  0.0
CD2_1AF =                  0.0
CD2_2AF =                 -1.0
CRPIX1F =                545.0
CRPIX2F =               4097.0
\end{alltt}


\end{document}

